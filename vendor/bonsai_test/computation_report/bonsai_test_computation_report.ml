open! Core
module Report = Bonsai_test.Computation_report
module Perf_configs = Bonsai_test_shared_for_testing_bonsai.Perf_configs

module%test [@name "list"] _ = struct
  let%expect_test "Startup" =
    Report.Startup.run_and_print_compare
      ~computations:(force Perf_configs.Dynamic_num.all_computations)
      (force Perf_configs.Dynamic_num.startup_inputs);
    [%expect
      {|
      ======= Startup Incr Node Stats =======
      ┌────────────────────────┬────────────┬────────────┬─────────────┬───────────────┬──────────────────┬───────────────────┐
      │                        │ max_height │ node_count │ max_node_id │ nodes_created │ nodes_recomputed │ nodes_invalidated │
      ├────────────────────────┼────────────┼────────────┼─────────────┼───────────────┼──────────────────┼───────────────────┤
      │ let%arr: 10            │  5         │     11     │      15     │      14       │     11           │ 0                 │
      │ bonsai.Map.map: 10     │  6         │     12     │      16     │      15       │     12           │ 0                 │
      │ assoc_simple: 10       │  6         │     12     │      16     │      15       │     12           │ 0                 │
      │ assoc: 10              │ 13         │     75     │     118     │     119       │     75           │ 0                 │
      │ let%arr: 1000          │  5         │     11     │      15     │      14       │     11           │ 0                 │
      │ bonsai.Map.map: 1000   │  6         │     12     │      16     │      15       │     12           │ 0                 │
      │ assoc_simple: 1000     │  6         │     12     │      16     │      15       │     12           │ 0                 │
      │ assoc: 1000            │ 13         │   6015     │   10018     │   10019       │   6015           │ 0                 │
      │ let%arr: 100000        │  5         │     11     │      15     │      14       │     11           │ 0                 │
      │ bonsai.Map.map: 100000 │  6         │     12     │      16     │      15       │     12           │ 0                 │
      │ assoc_simple: 100000   │  6         │     12     │      16     │      15       │     12           │ 0                 │
      │ assoc: 100000          │ 13         │ 600015     │ 1000018     │ 1000019       │ 600015           │ 0                 │
      └────────────────────────┴────────────┴────────────┴─────────────┴───────────────┴──────────────────┴───────────────────┘

      ======= Startup Incr Annotated Node Counts =======
      ┌───────────────────┬───────┬────────┬────────┬───────────┬────────────┬────────┬────────────┬───────────┬───────────┬───────────┬───────────┬─────────────┬───────────┬──────┬────────────────────────┐
      │                   │ input │ value  │ result │ lifecycle │ empty_life │ model  │ model_and_ │ switch_mo │ assoc_key │ assoc_inp │ assoc_res │ assoc_lifec │ assoc_inp │ path │ lifecycle_apply_action │
      │                   │       │        │        │           │ cycle      │        │ input      │ del       │           │ ut        │ ults      │ ycles       │ uts       │      │ _pair                  │
      ├───────────────────┼───────┼────────┼────────┼───────────┼────────────┼────────┼────────────┼───────────┼───────────┼───────────┼───────────┼─────────────┼───────────┼──────┼────────────────────────┤
      │ let%arr: 10       │ 0     │      1 │      1 │ 0         │      1     │      0 │      0     │ 0         │      0    │      0    │ 0         │ 0           │ 0         │ 0    │ 0                      │
      │ bonsai.Map.map:   │ 0     │      2 │      3 │ 0         │      1     │      0 │      0     │ 0         │      0    │      0    │ 0         │ 0           │ 0         │ 0    │ 0                      │
      │ 10                │       │        │        │           │            │        │            │           │           │           │           │             │           │      │                        │
      │ assoc_simple: 10  │ 0     │      2 │      3 │ 0         │      1     │      0 │      0     │ 0         │      0    │      0    │ 0         │ 0           │ 0         │ 0    │ 0                      │
      │ assoc: 10         │ 0     │     32 │     73 │ 0         │     11     │     10 │     10     │ 0         │     10    │     10    │ 1         │ 1           │ 1         │ 0    │ 0                      │
      │ let%arr: 1000     │ 0     │      1 │      1 │ 0         │      1     │      0 │      0     │ 0         │      0    │      0    │ 0         │ 0           │ 0         │ 0    │ 0                      │
      │ bonsai.Map.map:   │ 0     │      2 │      3 │ 0         │      1     │      0 │      0     │ 0         │      0    │      0    │ 0         │ 0           │ 0         │ 0    │ 0                      │
      │ 1000              │       │        │        │           │            │        │            │           │           │           │           │             │           │      │                        │
      │ assoc_simple:     │ 0     │      2 │      3 │ 0         │      1     │      0 │      0     │ 0         │      0    │      0    │ 0         │ 0           │ 0         │ 0    │ 0                      │
      │ 1000              │       │        │        │           │            │        │            │           │           │           │           │             │           │      │                        │
      │ assoc: 1000       │ 0     │   3002 │   7003 │ 0         │   1001     │   1000 │   1000     │ 0         │   1000    │   1000    │ 1         │ 1           │ 1         │ 0    │ 0                      │
      │ let%arr: 100000   │ 0     │      1 │      1 │ 0         │      1     │      0 │      0     │ 0         │      0    │      0    │ 0         │ 0           │ 0         │ 0    │ 0                      │
      │ bonsai.Map.map:   │ 0     │      2 │      3 │ 0         │      1     │      0 │      0     │ 0         │      0    │      0    │ 0         │ 0           │ 0         │ 0    │ 0                      │
      │ 100000            │       │        │        │           │            │        │            │           │           │           │           │             │           │      │                        │
      │ assoc_simple:     │ 0     │      2 │      3 │ 0         │      1     │      0 │      0     │ 0         │      0    │      0    │ 0         │ 0           │ 0         │ 0    │ 0                      │
      │ 100000            │       │        │        │           │            │        │            │           │           │           │           │             │           │      │                        │
      │ assoc: 100000     │ 0     │ 300002 │ 700003 │ 0         │ 100001     │ 100000 │ 100000     │ 0         │ 100000    │ 100000    │ 1         │ 1           │ 1         │ 0    │ 0                      │
      └───────────────────┴───────┴────────┴────────┴───────────┴────────────┴────────┴────────────┴───────────┴───────────┴───────────┴───────────┴─────────────┴───────────┴──────┴────────────────────────┘

      ======= Bonsai Computation Nodes =======
      ┌──────────────┬────────┬────────┬───────┬───────┬────────┬────────┬─────┬───────┬───────┬───────┬────────┬────────┬────────┬────────┬────────┬──────┬───────────┬──────┬────────┬────────┬────────────┐
      │              │ return │ leaf01 │ leaf1 │ leaf0 │ leaf_i │ model_ │ sub │ store │ fetch │ assoc │ assoc_ │ assoc_ │ switch │ fix_de │ fix_re │ wrap │ with_mode │ path │ lifecy │ identi │ computatio │
      │              │        │        │       │       │ ncr    │ cutoff │     │       │       │       │ on     │ simpl  │        │ fine   │ curse  │      │ l_resette │      │ cle    │ ty     │ n_watcher  │
      │              │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │ r         │      │        │        │            │
      ├──────────────┼────────┼────────┼───────┼───────┼────────┼────────┼─────┼───────┼───────┼───────┼────────┼────────┼────────┼────────┼────────┼──────┼───────────┼──────┼────────┼────────┼────────────┤
      │ let%arr: 10  │ 1      │ 0      │ 0     │ 0     │ 0      │ 0      │ 0   │ 0     │ 0     │ 0     │ 0      │ 0      │ 0      │ 0      │ 0      │ 0    │ 0         │ 0    │ 0      │ 0      │ 0          │
      │ bonsai.Map.m │ 0      │ 0      │ 0     │ 0     │ 2      │ 0      │ 1   │ 0     │ 0     │ 0     │ 0      │ 0      │ 0      │ 0      │ 0      │ 0    │ 0         │ 0    │ 0      │ 0      │ 0          │
      │ ap: 10       │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │           │      │        │        │            │
      │ assoc_simple │ 0      │ 0      │ 0     │ 0     │ 1      │ 0      │ 1   │ 0     │ 0     │ 0     │ 0      │ 1      │ 0      │ 0      │ 0      │ 0    │ 0         │ 0    │ 0      │ 0      │ 0          │
      │ : 10         │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │           │      │        │        │            │
      │ assoc: 10    │ 3      │ 0      │ 0     │ 1     │ 1      │ 0      │ 4   │ 0     │ 0     │ 1     │ 0      │ 0      │ 0      │ 0      │ 0      │ 0    │ 0         │ 0    │ 0      │ 0      │ 0          │
      │ let%arr:     │ 1      │ 0      │ 0     │ 0     │ 0      │ 0      │ 0   │ 0     │ 0     │ 0     │ 0      │ 0      │ 0      │ 0      │ 0      │ 0    │ 0         │ 0    │ 0      │ 0      │ 0          │
      │ 1000         │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │           │      │        │        │            │
      │ bonsai.Map.m │ 0      │ 0      │ 0     │ 0     │ 2      │ 0      │ 1   │ 0     │ 0     │ 0     │ 0      │ 0      │ 0      │ 0      │ 0      │ 0    │ 0         │ 0    │ 0      │ 0      │ 0          │
      │ ap: 1000     │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │           │      │        │        │            │
      │ assoc_simple │ 0      │ 0      │ 0     │ 0     │ 1      │ 0      │ 1   │ 0     │ 0     │ 0     │ 0      │ 1      │ 0      │ 0      │ 0      │ 0    │ 0         │ 0    │ 0      │ 0      │ 0          │
      │ : 1000       │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │           │      │        │        │            │
      │ assoc: 1000  │ 3      │ 0      │ 0     │ 1     │ 1      │ 0      │ 4   │ 0     │ 0     │ 1     │ 0      │ 0      │ 0      │ 0      │ 0      │ 0    │ 0         │ 0    │ 0      │ 0      │ 0          │
      │ let%arr:     │ 1      │ 0      │ 0     │ 0     │ 0      │ 0      │ 0   │ 0     │ 0     │ 0     │ 0      │ 0      │ 0      │ 0      │ 0      │ 0    │ 0         │ 0    │ 0      │ 0      │ 0          │
      │ 100000       │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │           │      │        │        │            │
      │ bonsai.Map.m │ 0      │ 0      │ 0     │ 0     │ 2      │ 0      │ 1   │ 0     │ 0     │ 0     │ 0      │ 0      │ 0      │ 0      │ 0      │ 0    │ 0         │ 0    │ 0      │ 0      │ 0          │
      │ ap: 100000   │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │           │      │        │        │            │
      │ assoc_simple │ 0      │ 0      │ 0     │ 0     │ 1      │ 0      │ 1   │ 0     │ 0     │ 0     │ 0      │ 1      │ 0      │ 0      │ 0      │ 0    │ 0         │ 0    │ 0      │ 0      │ 0          │
      │ : 100000     │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │           │      │        │        │            │
      │ assoc:       │ 3      │ 0      │ 0     │ 1     │ 1      │ 0      │ 4   │ 0     │ 0     │ 1     │ 0      │ 0      │ 0      │ 0      │ 0      │ 0    │ 0         │ 0    │ 0      │ 0      │ 0          │
      │ 100000       │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │           │      │        │        │            │
      └──────────────┴────────┴────────┴───────┴───────┴────────┴────────┴─────┴───────┴───────┴───────┴────────┴────────┴────────┴────────┴────────┴──────┴───────────┴──────┴────────┴────────┴────────────┘

      ======= Bonsai Value Nodes =======
      ┌────────────────────────┬──────────┬────────────┬──────┬───────┬────────┬──────┐
      │                        │ constant │ exception_ │ incr │ named │ cutoff │ mapn │
      ├────────────────────────┼──────────┼────────────┼──────┼───────┼────────┼──────┤
      │ let%arr: 10            │ 0        │ 0          │ 1    │ 0     │ 0      │ 1    │
      │ bonsai.Map.map: 10     │ 0        │ 0          │ 1    │ 1     │ 0      │ 0    │
      │ assoc_simple: 10       │ 0        │ 0          │ 1    │ 1     │ 0      │ 0    │
      │ assoc: 10              │ 0        │ 0          │ 1    │ 5     │ 0      │ 3    │
      │ let%arr: 1000          │ 0        │ 0          │ 1    │ 0     │ 0      │ 1    │
      │ bonsai.Map.map: 1000   │ 0        │ 0          │ 1    │ 1     │ 0      │ 0    │
      │ assoc_simple: 1000     │ 0        │ 0          │ 1    │ 1     │ 0      │ 0    │
      │ assoc: 1000            │ 0        │ 0          │ 1    │ 5     │ 0      │ 3    │
      │ let%arr: 100000        │ 0        │ 0          │ 1    │ 0     │ 0      │ 1    │
      │ bonsai.Map.map: 100000 │ 0        │ 0          │ 1    │ 1     │ 0      │ 0    │
      │ assoc_simple: 100000   │ 0        │ 0          │ 1    │ 1     │ 0      │ 0    │
      │ assoc: 100000          │ 0        │ 0          │ 1    │ 5     │ 0      │ 3    │
      └────────────────────────┴──────────┴────────────┴──────┴───────┴────────┴──────┘
      |}]
  ;;

  let%expect_test "Interaction" =
    Report.Interaction.run_and_print_compare
      ~get_inject:(fun _ _ -> assert false)
      ~computations:(force Perf_configs.Dynamic_num.all_computations)
      (force Perf_configs.Dynamic_num.scenarios);
    [%expect
      {|
      ====== Node Count ======
      ┌────────────────────────────────┬─────────┬────────────────┬──────────────┬────────┐
      │                                │ let%arr │ bonsai.Map.map │ assoc_simple │ assoc  │
      ├────────────────────────────────┼─────────┼────────────────┼──────────────┼────────┤
      │ 10, (1/5) updated 5 times      │ 11      │ 12             │ 12           │     75 │
      │ 10, (1/10) updated 5 times     │ 11      │ 12             │ 12           │     75 │
      │ 10, (1/50) updated 5 times     │ 11      │ 12             │ 12           │     75 │
      │ 1000, (1/5) updated 5 times    │ 11      │ 12             │ 12           │   6015 │
      │ 1000, (1/10) updated 5 times   │ 11      │ 12             │ 12           │   6015 │
      │ 1000, (1/50) updated 5 times   │ 11      │ 12             │ 12           │   6015 │
      │ 100000, (1/5) updated 5 times  │ 11      │ 12             │ 12           │ 600015 │
      │ 100000, (1/10) updated 5 times │ 11      │ 12             │ 12           │ 600015 │
      │ 100000, (1/50) updated 5 times │ 11      │ 12             │ 12           │ 600015 │
      └────────────────────────────────┴─────────┴────────────────┴──────────────┴────────┘

      ====== Nodes Created ======
      ┌────────────────────────────────┬─────────┬────────────────┬──────────────┬───────┐
      │                                │ let%arr │ bonsai.Map.map │ assoc_simple │ assoc │
      ├────────────────────────────────┼─────────┼────────────────┼──────────────┼───────┤
      │ 10, (1/5) updated 5 times      │ 0       │ 0              │ 0            │ 0     │
      │ 10, (1/10) updated 5 times     │ 0       │ 0              │ 0            │ 0     │
      │ 10, (1/50) updated 5 times     │ 0       │ 0              │ 0            │ 0     │
      │ 1000, (1/5) updated 5 times    │ 0       │ 0              │ 0            │ 0     │
      │ 1000, (1/10) updated 5 times   │ 0       │ 0              │ 0            │ 0     │
      │ 1000, (1/50) updated 5 times   │ 0       │ 0              │ 0            │ 0     │
      │ 100000, (1/5) updated 5 times  │ 0       │ 0              │ 0            │ 0     │
      │ 100000, (1/10) updated 5 times │ 0       │ 0              │ 0            │ 0     │
      │ 100000, (1/50) updated 5 times │ 0       │ 0              │ 0            │ 0     │
      └────────────────────────────────┴─────────┴────────────────┴──────────────┴───────┘

      ====== Nodes Recomputed ======
      ┌────────────────────────────────┬─────────┬────────────────┬──────────────┬────────┐
      │                                │ let%arr │ bonsai.Map.map │ assoc_simple │ assoc  │
      ├────────────────────────────────┼─────────┼────────────────┼──────────────┼────────┤
      │ 10, (1/5) updated 5 times      │ 28      │ 32             │ 32           │    100 │
      │ 10, (1/10) updated 5 times     │ 28      │ 32             │ 32           │     76 │
      │ 10, (1/50) updated 5 times     │ 28      │ 32             │ 32           │     76 │
      │ 1000, (1/5) updated 5 times    │ 28      │ 32             │ 32           │   5644 │
      │ 1000, (1/10) updated 5 times   │ 28      │ 32             │ 32           │   3244 │
      │ 1000, (1/50) updated 5 times   │ 28      │ 32             │ 32           │    684 │
      │ 100000, (1/5) updated 5 times  │ 28      │ 32             │ 32           │ 560044 │
      │ 100000, (1/10) updated 5 times │ 28      │ 32             │ 32           │ 320044 │
      │ 100000, (1/50) updated 5 times │ 28      │ 32             │ 32           │  64044 │
      └────────────────────────────────┴─────────┴────────────────┴──────────────┴────────┘

      ====== Nodes Invalidated ======
      ┌────────────────────────────────┬─────────┬────────────────┬──────────────┬───────┐
      │                                │ let%arr │ bonsai.Map.map │ assoc_simple │ assoc │
      ├────────────────────────────────┼─────────┼────────────────┼──────────────┼───────┤
      │ 10, (1/5) updated 5 times      │ 0       │ 0              │ 0            │ 0     │
      │ 10, (1/10) updated 5 times     │ 0       │ 0              │ 0            │ 0     │
      │ 10, (1/50) updated 5 times     │ 0       │ 0              │ 0            │ 0     │
      │ 1000, (1/5) updated 5 times    │ 0       │ 0              │ 0            │ 0     │
      │ 1000, (1/10) updated 5 times   │ 0       │ 0              │ 0            │ 0     │
      │ 1000, (1/50) updated 5 times   │ 0       │ 0              │ 0            │ 0     │
      │ 100000, (1/5) updated 5 times  │ 0       │ 0              │ 0            │ 0     │
      │ 100000, (1/10) updated 5 times │ 0       │ 0              │ 0            │ 0     │
      │ 100000, (1/50) updated 5 times │ 0       │ 0              │ 0            │ 0     │
      └────────────────────────────────┴─────────┴────────────────┴──────────────┴───────┘
      |}]
  ;;
end

module%test [@name "switch"] _ = struct
  let%expect_test "Startup" =
    Report.Startup.run_and_print_compare
      ~computations:(force Perf_configs.Switch.all_computations)
      Perf_configs.Switch.startup_inputs;
    [%expect
      {|
      ======= Startup Incr Node Stats =======
      ┌────────────────────────────────────────────┬────────────┬────────────┬─────────────┬───────────────┬──────────────────┬───────────────────┐
      │                                            │ max_height │ node_count │ max_node_id │ nodes_created │ nodes_recomputed │ nodes_invalidated │
      ├────────────────────────────────────────────┼────────────┼────────────┼─────────────┼───────────────┼──────────────────┼───────────────────┤
      │ arr+match: Start true                      │  8         │ 18         │ 23          │ 22            │ 18               │ 0                 │
      │ arr+match (state): Start true              │  5         │ 11         │ 15          │ 14            │ 11               │ 0                 │
      │ arr+match (two inputs): Start true         │  8         │ 19         │ 25          │ 23            │ 19               │ 0                 │
      │ arr+match (state, two inputs): Start true  │  5         │ 12         │ 17          │ 15            │ 12               │ 0                 │
      │ match%sub: Start true                      │ 10         │ 20         │ 31          │ 30            │ 20               │ 0                 │
      │ match%sub (state): Start true              │ 10         │ 17         │ 29          │ 28            │ 17               │ 0                 │
      │ match%sub (two inputs): Start true         │ 11         │ 22         │ 34          │ 32            │ 22               │ 0                 │
      │ match%sub (state, two inputs): Start true  │ 11         │ 19         │ 32          │ 30            │ 19               │ 0                 │
      │ arr+match: Start false                     │  8         │ 18         │ 23          │ 22            │ 18               │ 0                 │
      │ arr+match (state): Start false             │  5         │ 11         │ 15          │ 14            │ 11               │ 0                 │
      │ arr+match (two inputs): Start false        │  8         │ 19         │ 25          │ 23            │ 19               │ 0                 │
      │ arr+match (state, two inputs): Start false │  5         │ 12         │ 17          │ 15            │ 12               │ 0                 │
      │ match%sub: Start false                     │ 10         │ 20         │ 31          │ 30            │ 20               │ 0                 │
      │ match%sub (state): Start false             │ 10         │ 17         │ 29          │ 28            │ 17               │ 0                 │
      │ match%sub (two inputs): Start false        │ 11         │ 22         │ 34          │ 32            │ 22               │ 0                 │
      │ match%sub (state, two inputs): Start false │ 11         │ 19         │ 32          │ 30            │ 19               │ 0                 │
      └────────────────────────────────────────────┴────────────┴────────────┴─────────────┴───────────────┴──────────────────┴───────────────────┘

      ======= Startup Incr Annotated Node Counts =======
      ┌────────────────────────────────┬───────┬───────┬────────┬───────────┬───────────┬───────┬───────────┬───────────┬───────────┬───────────┬───────────┬───────────┬───────────┬──────┬─────────────────┐
      │                                │ input │ value │ result │ lifecycle │ empty_lif │ model │ model_and │ switch_mo │ assoc_key │ assoc_inp │ assoc_res │ assoc_lif │ assoc_inp │ path │ lifecycle_apply │
      │                                │       │       │        │           │ ecycle    │       │ _input    │ del       │           │ ut        │ ults      │ ecycles   │ uts       │      │ _action_pair    │
      ├────────────────────────────────┼───────┼───────┼────────┼───────────┼───────────┼───────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼──────┼─────────────────┤
      │ arr+match: Start true          │ 0     │ 5     │ 13     │ 0         │ 1         │ 3     │ 0         │ 0         │ 0         │ 0         │ 0         │ 0         │ 0         │ 0    │ 0               │
      │ arr+match (state): Start true  │ 0     │ 1     │  1     │ 0         │ 1         │ 0     │ 0         │ 0         │ 0         │ 0         │ 0         │ 0         │ 0         │ 0    │ 0               │
      │ arr+match (two inputs): Start  │ 0     │ 5     │ 13     │ 0         │ 1         │ 3     │ 0         │ 0         │ 0         │ 0         │ 0         │ 0         │ 0         │ 0    │ 0               │
      │ true                           │       │       │        │           │           │       │           │           │           │           │           │           │           │      │                 │
      │ arr+match (state, two          │ 0     │ 1     │  1     │ 0         │ 1         │ 0     │ 0         │ 0         │ 0         │ 0         │ 0         │ 0         │ 0         │ 0    │ 0               │
      │ inputs): Start true            │       │       │        │           │           │       │           │           │           │           │           │           │           │      │                 │
      │ match%sub: Start true          │ 0     │ 5     │ 10     │ 0         │ 2         │ 1     │ 0         │ 1         │ 0         │ 0         │ 0         │ 0         │ 0         │ 0    │ 0               │
      │ match%sub (state): Start true  │ 0     │ 3     │  4     │ 0         │ 2         │ 0     │ 0         │ 1         │ 0         │ 0         │ 0         │ 0         │ 0         │ 0    │ 0               │
      │ match%sub (two inputs): Start  │ 0     │ 6     │ 12     │ 0         │ 2         │ 1     │ 0         │ 1         │ 0         │ 0         │ 0         │ 0         │ 0         │ 0    │ 0               │
      │ true                           │       │       │        │           │           │       │           │           │           │           │           │           │           │      │                 │
      │ match%sub (state, two          │ 0     │ 4     │  6     │ 0         │ 2         │ 0     │ 0         │ 1         │ 0         │ 0         │ 0         │ 0         │ 0         │ 0    │ 0               │
      │ inputs): Start true            │       │       │        │           │           │       │           │           │           │           │           │           │           │      │                 │
      │ arr+match: Start false         │ 0     │ 5     │ 13     │ 0         │ 1         │ 3     │ 0         │ 0         │ 0         │ 0         │ 0         │ 0         │ 0         │ 0    │ 0               │
      │ arr+match (state): Start false │ 0     │ 1     │  1     │ 0         │ 1         │ 0     │ 0         │ 0         │ 0         │ 0         │ 0         │ 0         │ 0         │ 0    │ 0               │
      │ arr+match (two inputs): Start  │ 0     │ 5     │ 13     │ 0         │ 1         │ 3     │ 0         │ 0         │ 0         │ 0         │ 0         │ 0         │ 0         │ 0    │ 0               │
      │ false                          │       │       │        │           │           │       │           │           │           │           │           │           │           │      │                 │
      │ arr+match (state, two          │ 0     │ 1     │  1     │ 0         │ 1         │ 0     │ 0         │ 0         │ 0         │ 0         │ 0         │ 0         │ 0         │ 0    │ 0               │
      │ inputs): Start false           │       │       │        │           │           │       │           │           │           │           │           │           │           │      │                 │
      │ match%sub: Start false         │ 0     │ 5     │ 10     │ 0         │ 2         │ 1     │ 0         │ 1         │ 0         │ 0         │ 0         │ 0         │ 0         │ 0    │ 0               │
      │ match%sub (state): Start false │ 0     │ 3     │  4     │ 0         │ 2         │ 0     │ 0         │ 1         │ 0         │ 0         │ 0         │ 0         │ 0         │ 0    │ 0               │
      │ match%sub (two inputs): Start  │ 0     │ 6     │ 12     │ 0         │ 2         │ 1     │ 0         │ 1         │ 0         │ 0         │ 0         │ 0         │ 0         │ 0    │ 0               │
      │ false                          │       │       │        │           │           │       │           │           │           │           │           │           │           │      │                 │
      │ match%sub (state, two          │ 0     │ 4     │  6     │ 0         │ 2         │ 0     │ 0         │ 1         │ 0         │ 0         │ 0         │ 0         │ 0         │ 0    │ 0               │
      │ inputs): Start false           │       │       │        │           │           │       │           │           │           │           │           │           │           │      │                 │
      └────────────────────────────────┴───────┴───────┴────────┴───────────┴───────────┴───────┴───────────┴───────────┴───────────┴───────────┴───────────┴───────────┴───────────┴──────┴─────────────────┘

      ======= Bonsai Computation Nodes =======
      ┌─────────────────────┬────────┬────────┬───────┬───────┬────────┬────────┬─────┬───────┬───────┬───────┬────────┬────────┬────────┬────────┬────────┬──────┬────────┬──────┬────────┬────────┬────────┐
      │                     │ return │ leaf01 │ leaf1 │ leaf0 │ leaf_i │ model_ │ sub │ store │ fetch │ assoc │ assoc_ │ assoc_ │ switch │ fix_de │ fix_re │ wrap │ with_m │ path │ lifecy │ identi │ comput │
      │                     │        │        │       │       │ ncr    │ cutoff │     │       │       │       │ on     │ simpl  │        │ fine   │ curse  │      │ odel_r │      │ cle    │ ty     │ ation_ │
      │                     │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │ esette │      │        │        │ watche │
      │                     │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │ r      │      │        │        │ r      │
      ├─────────────────────┼────────┼────────┼───────┼───────┼────────┼────────┼─────┼───────┼───────┼───────┼────────┼────────┼────────┼────────┼────────┼──────┼────────┼──────┼────────┼────────┼────────┤
      │ arr+match: Start    │ 5      │ 0      │ 0     │ 2     │ 0      │ 0      │ 6   │ 0     │ 0     │ 0     │ 0      │ 0      │ 0      │ 0      │ 0      │ 0    │ 0      │ 0    │ 0      │ 0      │ 0      │
      │ true                │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │        │      │        │        │        │
      │ arr+match (state):  │ 1      │ 0      │ 0     │ 0     │ 0      │ 0      │ 0   │ 0     │ 0     │ 0     │ 0      │ 0      │ 0      │ 0      │ 0      │ 0    │ 0      │ 0    │ 0      │ 0      │ 0      │
      │ Start true          │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │        │      │        │        │        │
      │ arr+match (two      │ 5      │ 0      │ 0     │ 2     │ 0      │ 0      │ 6   │ 0     │ 0     │ 0     │ 0      │ 0      │ 0      │ 0      │ 0      │ 0    │ 0      │ 0    │ 0      │ 0      │ 0      │
      │ inputs): Start true │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │        │      │        │        │        │
      │ arr+match (state,   │ 1      │ 0      │ 0     │ 0     │ 0      │ 0      │ 0   │ 0     │ 0     │ 0     │ 0      │ 0      │ 0      │ 0      │ 0      │ 0    │ 0      │ 0    │ 0      │ 0      │ 0      │
      │ two inputs): Start  │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │        │      │        │        │        │
      │ true                │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │        │      │        │        │        │
      │ match%sub: Start    │ 7      │ 0      │ 0     │ 2     │ 0      │ 0      │ 7   │ 0     │ 0     │ 0     │ 0      │ 0      │ 1      │ 0      │ 0      │ 0    │ 0      │ 0    │ 0      │ 0      │ 0      │
      │ true                │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │        │      │        │        │        │
      │ match%sub (state):  │ 3      │ 0      │ 0     │ 0     │ 0      │ 0      │ 1   │ 0     │ 0     │ 0     │ 0      │ 0      │ 1      │ 0      │ 0      │ 0    │ 0      │ 0    │ 0      │ 0      │ 0      │
      │ Start true          │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │        │      │        │        │        │
      │ match%sub (two      │ 8      │ 0      │ 0     │ 2     │ 0      │ 0      │ 8   │ 0     │ 0     │ 0     │ 0      │ 0      │ 1      │ 0      │ 0      │ 0    │ 0      │ 0    │ 0      │ 0      │ 0      │
      │ inputs): Start true │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │        │      │        │        │        │
      │ match%sub (state,   │ 4      │ 0      │ 0     │ 0     │ 0      │ 0      │ 2   │ 0     │ 0     │ 0     │ 0      │ 0      │ 1      │ 0      │ 0      │ 0    │ 0      │ 0    │ 0      │ 0      │ 0      │
      │ two inputs): Start  │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │        │      │        │        │        │
      │ true                │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │        │      │        │        │        │
      │ arr+match: Start    │ 5      │ 0      │ 0     │ 2     │ 0      │ 0      │ 6   │ 0     │ 0     │ 0     │ 0      │ 0      │ 0      │ 0      │ 0      │ 0    │ 0      │ 0    │ 0      │ 0      │ 0      │
      │ false               │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │        │      │        │        │        │
      │ arr+match (state):  │ 1      │ 0      │ 0     │ 0     │ 0      │ 0      │ 0   │ 0     │ 0     │ 0     │ 0      │ 0      │ 0      │ 0      │ 0      │ 0    │ 0      │ 0    │ 0      │ 0      │ 0      │
      │ Start false         │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │        │      │        │        │        │
      │ arr+match (two      │ 5      │ 0      │ 0     │ 2     │ 0      │ 0      │ 6   │ 0     │ 0     │ 0     │ 0      │ 0      │ 0      │ 0      │ 0      │ 0    │ 0      │ 0    │ 0      │ 0      │ 0      │
      │ inputs): Start      │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │        │      │        │        │        │
      │ false               │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │        │      │        │        │        │
      │ arr+match (state,   │ 1      │ 0      │ 0     │ 0     │ 0      │ 0      │ 0   │ 0     │ 0     │ 0     │ 0      │ 0      │ 0      │ 0      │ 0      │ 0    │ 0      │ 0    │ 0      │ 0      │ 0      │
      │ two inputs): Start  │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │        │      │        │        │        │
      │ false               │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │        │      │        │        │        │
      │ match%sub: Start    │ 7      │ 0      │ 0     │ 2     │ 0      │ 0      │ 7   │ 0     │ 0     │ 0     │ 0      │ 0      │ 1      │ 0      │ 0      │ 0    │ 0      │ 0    │ 0      │ 0      │ 0      │
      │ false               │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │        │      │        │        │        │
      │ match%sub (state):  │ 3      │ 0      │ 0     │ 0     │ 0      │ 0      │ 1   │ 0     │ 0     │ 0     │ 0      │ 0      │ 1      │ 0      │ 0      │ 0    │ 0      │ 0    │ 0      │ 0      │ 0      │
      │ Start false         │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │        │      │        │        │        │
      │ match%sub (two      │ 8      │ 0      │ 0     │ 2     │ 0      │ 0      │ 8   │ 0     │ 0     │ 0     │ 0      │ 0      │ 1      │ 0      │ 0      │ 0    │ 0      │ 0    │ 0      │ 0      │ 0      │
      │ inputs): Start      │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │        │      │        │        │        │
      │ false               │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │        │      │        │        │        │
      │ match%sub (state,   │ 4      │ 0      │ 0     │ 0     │ 0      │ 0      │ 2   │ 0     │ 0     │ 0     │ 0      │ 0      │ 1      │ 0      │ 0      │ 0    │ 0      │ 0    │ 0      │ 0      │ 0      │
      │ two inputs): Start  │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │        │      │        │        │        │
      │ false               │        │        │       │       │        │        │     │       │       │       │        │        │        │        │        │      │        │      │        │        │        │
      └─────────────────────┴────────┴────────┴───────┴───────┴────────┴────────┴─────┴───────┴───────┴───────┴────────┴────────┴────────┴────────┴────────┴──────┴────────┴──────┴────────┴────────┴────────┘

      ======= Bonsai Value Nodes =======
      ┌────────────────────────────────────────────┬──────────┬────────────┬──────┬───────┬────────┬──────┐
      │                                            │ constant │ exception_ │ incr │ named │ cutoff │ mapn │
      ├────────────────────────────────────────────┼──────────┼────────────┼──────┼───────┼────────┼──────┤
      │ arr+match: Start true                      │ 0        │ 0          │ 1    │ 6     │ 0      │ 5    │
      │ arr+match (state): Start true              │ 0        │ 0          │ 1    │ 0     │ 0      │ 1    │
      │ arr+match (two inputs): Start true         │ 0        │ 0          │ 2    │ 6     │ 0      │ 5    │
      │ arr+match (state, two inputs): Start true  │ 0        │ 0          │ 2    │ 0     │ 0      │ 1    │
      │ match%sub: Start true                      │ 0        │ 0          │ 1    │ 7     │ 0      │ 5    │
      │ match%sub (state): Start true              │ 2        │ 0          │ 1    │ 1     │ 0      │ 1    │
      │ match%sub (two inputs): Start true         │ 0        │ 0          │ 2    │ 8     │ 0      │ 6    │
      │ match%sub (state, two inputs): Start true  │ 2        │ 0          │ 2    │ 2     │ 0      │ 2    │
      │ arr+match: Start false                     │ 0        │ 0          │ 1    │ 6     │ 0      │ 5    │
      │ arr+match (state): Start false             │ 0        │ 0          │ 1    │ 0     │ 0      │ 1    │
      │ arr+match (two inputs): Start false        │ 0        │ 0          │ 2    │ 6     │ 0      │ 5    │
      │ arr+match (state, two inputs): Start false │ 0        │ 0          │ 2    │ 0     │ 0      │ 1    │
      │ match%sub: Start false                     │ 0        │ 0          │ 1    │ 7     │ 0      │ 5    │
      │ match%sub (state): Start false             │ 2        │ 0          │ 1    │ 1     │ 0      │ 1    │
      │ match%sub (two inputs): Start false        │ 0        │ 0          │ 2    │ 8     │ 0      │ 6    │
      │ match%sub (state, two inputs): Start false │ 2        │ 0          │ 2    │ 2     │ 0      │ 2    │
      └────────────────────────────────────────────┴──────────┴────────────┴──────┴───────┴────────┴──────┘
      |}]
  ;;

  let%expect_test "Interaction" =
    Report.Interaction.run_and_print_compare
      ~get_inject:(fun _ _ -> assert false)
      ~computations:(force Perf_configs.Switch.all_computations)
      Perf_configs.Switch.scenarios;
    [%expect
      {|
      ====== Node Count ======
      ┌────────────────────────────┬───────────┬───────────────────┬──────────────────────┬─────────────────────────────┬───────────┬───────────────────┬──────────────────────┬─────────────────────────────┐
      │                            │ arr+match │ arr+match (state) │ arr+match (two       │ arr+match (state, two       │ match%sub │ match%sub (state) │ match%sub (two       │ match%sub (state, two       │
      │                            │           │                   │ inputs)              │ inputs)                     │           │                   │ inputs)              │ inputs)                     │
      ├────────────────────────────┼───────────┼───────────────────┼──────────────────────┼─────────────────────────────┼───────────┼───────────────────┼──────────────────────┼─────────────────────────────┤
      │ Start false, switch 1      │ 18        │ 11                │ 19                   │ 12                          │ 20        │ 17                │ 22                   │ 19                          │
      │ times                      │           │                   │                      │                             │           │                   │                      │                             │
      │ Start true, switch 1 times │ 18        │ 11                │ 19                   │ 12                          │ 20        │ 17                │ 22                   │ 19                          │
      │ Start false, switch 5      │ 18        │ 11                │ 19                   │ 12                          │ 20        │ 17                │ 22                   │ 19                          │
      │ times                      │           │                   │                      │                             │           │                   │                      │                             │
      │ Start true, switch 5 times │ 18        │ 11                │ 19                   │ 12                          │ 20        │ 17                │ 22                   │ 19                          │
      │ Start false, switch 10     │ 18        │ 11                │ 19                   │ 12                          │ 20        │ 17                │ 22                   │ 19                          │
      │ times                      │           │                   │                      │                             │           │                   │                      │                             │
      │ Start true, switch 10      │ 18        │ 11                │ 19                   │ 12                          │ 20        │ 17                │ 22                   │ 19                          │
      │ times                      │           │                   │                      │                             │           │                   │                      │                             │
      │ Start false, switch 100    │ 18        │ 11                │ 19                   │ 12                          │ 20        │ 17                │ 22                   │ 19                          │
      │ times                      │           │                   │                      │                             │           │                   │                      │                             │
      │ Start true, switch 100     │ 18        │ 11                │ 19                   │ 12                          │ 20        │ 17                │ 22                   │ 19                          │
      │ times                      │           │                   │                      │                             │           │                   │                      │                             │
      └────────────────────────────┴───────────┴───────────────────┴──────────────────────┴─────────────────────────────┴───────────┴───────────────────┴──────────────────────┴─────────────────────────────┘

      ====== Nodes Created ======
      ┌────────────────────────────┬───────────┬───────────────────┬──────────────────────┬─────────────────────────────┬───────────┬───────────────────┬──────────────────────┬─────────────────────────────┐
      │                            │ arr+match │ arr+match (state) │ arr+match (two       │ arr+match (state, two       │ match%sub │ match%sub (state) │ match%sub (two       │ match%sub (state, two       │
      │                            │           │                   │ inputs)              │ inputs)                     │           │                   │ inputs)              │ inputs)                     │
      ├────────────────────────────┼───────────┼───────────────────┼──────────────────────┼─────────────────────────────┼───────────┼───────────────────┼──────────────────────┼─────────────────────────────┤
      │ Start false, switch 1      │ 0         │ 0                 │ 0                    │ 0                           │   0       │   0               │   0                  │   0                         │
      │ times                      │           │                   │                      │                             │           │                   │                      │                             │
      │ Start true, switch 1 times │ 0         │ 0                 │ 0                    │ 0                           │   0       │   0               │   0                  │   0                         │
      │ Start false, switch 5      │ 0         │ 0                 │ 0                    │ 0                           │  32       │  24               │  32                  │  24                         │
      │ times                      │           │                   │                      │                             │           │                   │                      │                             │
      │ Start true, switch 5 times │ 0         │ 0                 │ 0                    │ 0                           │  32       │  24               │  32                  │  24                         │
      │ Start false, switch 10     │ 0         │ 0                 │ 0                    │ 0                           │  64       │  48               │  64                  │  48                         │
      │ times                      │           │                   │                      │                             │           │                   │                      │                             │
      │ Start true, switch 10      │ 0         │ 0                 │ 0                    │ 0                           │  64       │  48               │  64                  │  48                         │
      │ times                      │           │                   │                      │                             │           │                   │                      │                             │
      │ Start false, switch 100    │ 0         │ 0                 │ 0                    │ 0                           │ 784       │ 588               │ 784                  │ 588                         │
      │ times                      │           │                   │                      │                             │           │                   │                      │                             │
      │ Start true, switch 100     │ 0         │ 0                 │ 0                    │ 0                           │ 784       │ 588               │ 784                  │ 588                         │
      │ times                      │           │                   │                      │                             │           │                   │                      │                             │
      └────────────────────────────┴───────────┴───────────────────┴──────────────────────┴─────────────────────────────┴───────────┴───────────────────┴──────────────────────┴─────────────────────────────┘

      ====== Nodes Recomputed ======
      ┌────────────────────────────┬───────────┬───────────────────┬──────────────────────┬─────────────────────────────┬───────────┬───────────────────┬──────────────────────┬─────────────────────────────┐
      │                            │ arr+match │ arr+match (state) │ arr+match (two       │ arr+match (state, two       │ match%sub │ match%sub (state) │ match%sub (two       │ match%sub (state, two       │
      │                            │           │                   │ inputs)              │ inputs)                     │           │                   │ inputs)              │ inputs)                     │
      ├────────────────────────────┼───────────┼───────────────────┼──────────────────────┼─────────────────────────────┼───────────┼───────────────────┼──────────────────────┼─────────────────────────────┤
      │ Start false, switch 1      │   0       │   0               │   0                  │   0                         │    0      │    0              │    0                 │    0                        │
      │ times                      │           │                   │                      │                             │           │                   │                      │                             │
      │ Start true, switch 1 times │   0       │   0               │   0                  │   0                         │    0      │    0              │    0                 │    0                        │
      │ Start false, switch 5      │  32       │  28               │  32                  │  28                         │   64      │   52              │   68                 │   56                        │
      │ times                      │           │                   │                      │                             │           │                   │                      │                             │
      │ Start true, switch 5 times │  32       │  28               │  32                  │  28                         │   64      │   52              │   68                 │   56                        │
      │ Start false, switch 10     │  66       │  57               │  66                  │  57                         │  130      │  105              │  138                 │  113                        │
      │ times                      │           │                   │                      │                             │           │                   │                      │                             │
      │ Start true, switch 10      │  66       │  57               │  66                  │  57                         │  130      │  105              │  138                 │  113                        │
      │ times                      │           │                   │                      │                             │           │                   │                      │                             │
      │ Start false, switch 100    │ 786       │ 687               │ 786                  │ 687                         │ 1570      │ 1275              │ 1668                 │ 1373                        │
      │ times                      │           │                   │                      │                             │           │                   │                      │                             │
      │ Start true, switch 100     │ 786       │ 687               │ 786                  │ 687                         │ 1570      │ 1275              │ 1668                 │ 1373                        │
      │ times                      │           │                   │                      │                             │           │                   │                      │                             │
      └────────────────────────────┴───────────┴───────────────────┴──────────────────────┴─────────────────────────────┴───────────┴───────────────────┴──────────────────────┴─────────────────────────────┘

      ====== Nodes Invalidated ======
      ┌────────────────────────────┬───────────┬───────────────────┬──────────────────────┬─────────────────────────────┬───────────┬───────────────────┬──────────────────────┬─────────────────────────────┐
      │                            │ arr+match │ arr+match (state) │ arr+match (two       │ arr+match (state, two       │ match%sub │ match%sub (state) │ match%sub (two       │ match%sub (state, two       │
      │                            │           │                   │ inputs)              │ inputs)                     │           │                   │ inputs)              │ inputs)                     │
      ├────────────────────────────┼───────────┼───────────────────┼──────────────────────┼─────────────────────────────┼───────────┼───────────────────┼──────────────────────┼─────────────────────────────┤
      │ Start false, switch 1      │ 0         │ 0                 │ 0                    │ 0                           │   0       │   0               │   0                  │   0                         │
      │ times                      │           │                   │                      │                             │           │                   │                      │                             │
      │ Start true, switch 1 times │ 0         │ 0                 │ 0                    │ 0                           │   0       │   0               │   0                  │   0                         │
      │ Start false, switch 5      │ 0         │ 0                 │ 0                    │ 0                           │  32       │  24               │  32                  │  24                         │
      │ times                      │           │                   │                      │                             │           │                   │                      │                             │
      │ Start true, switch 5 times │ 0         │ 0                 │ 0                    │ 0                           │  32       │  24               │  32                  │  24                         │
      │ Start false, switch 10     │ 0         │ 0                 │ 0                    │ 0                           │  64       │  48               │  64                  │  48                         │
      │ times                      │           │                   │                      │                             │           │                   │                      │                             │
      │ Start true, switch 10      │ 0         │ 0                 │ 0                    │ 0                           │  64       │  48               │  64                  │  48                         │
      │ times                      │           │                   │                      │                             │           │                   │                      │                             │
      │ Start false, switch 100    │ 0         │ 0                 │ 0                    │ 0                           │ 784       │ 588               │ 784                  │ 588                         │
      │ times                      │           │                   │                      │                             │           │                   │                      │                             │
      │ Start true, switch 100     │ 0         │ 0                 │ 0                    │ 0                           │ 784       │ 588               │ 784                  │ 588                         │
      │ times                      │           │                   │                      │                             │           │                   │                      │                             │
      └────────────────────────────┴───────────┴───────────────────┴──────────────────────┴─────────────────────────────┴───────────┴───────────────────┴──────────────────────┴─────────────────────────────┘
      |}]
  ;;
end
